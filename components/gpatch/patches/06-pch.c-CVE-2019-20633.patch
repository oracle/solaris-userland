From 0b80cfe92468026cb34ea171cb9867de91e7c731 Mon Sep 17 00:00:00 2001
From: yixiangzhike <yixiangzhike007@163.com>
Date: Wed, 7 Dec 2022 19:46:01 +0800
Subject: [PATCH] Clear the length and pointer after the pointer is released.

bug: https://savannah.gnu.org/bugs/index.php?56683

==2576==ERROR: AddressSanitizer: attempting double-free on 0x60200000ed90 in thread T0:
    #0 0x7f237fe6832a in __interceptor_free (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x9832a)
    #1 0x414188 in another_hunk ../../src/pch.c:1187
    #2 0x406ce2 in main ../../src/patch.c:408
    #3 0x7f237fa2682f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
    #4 0x4037e8 in _start (/home/dungnguyen/PoCs/patch_76e7758/patch-asan+0x4037e8)
0x60200000ed90 is located 0 bytes inside of 4-byte region [0x60200000ed90,0x60200000ed94)
freed by thread T0 here:
    #0 0x7f237fe6832a in __interceptor_free (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x9832a)
    #1 0x414188 in another_hunk ../../src/pch.c:1187
    #2 0x406ce2 in main ../../src/patch.c:408
    #3 0x7f237fa2682f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
previously allocated by thread T0 here:
    #0 0x7f237fe68662 in malloc (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x98662)
    #1 0x421b71 in savebuf ../../src/util.c:869
    #2 0x415595 in another_hunk ../../src/pch.c:1443
    #3 0x406ce2 in main ../../src/patch.c:408
    #4 0x7f237fa2682f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)
---
 src/pch.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/src/pch.c b/src/pch.c
index 8dda771..6b036ba 100644
--- a/src/pch.c
+++ b/src/pch.c
@@ -1190,8 +1190,11 @@ another_hunk (enum diff difftype, bool rev)
     while (p_end >= 0) {
 	if (p_end == p_efake)
 	    p_end = p_bfake;		/* don't free twice */
-	else
+	else {
 	    free(p_line[p_end]);
+	    p_line[p_end] = NULL;
+	    p_len[p_end] = 0;
+	}
 	p_end--;
     }
     assert(p_end == -1);
-- 
2.27.0

