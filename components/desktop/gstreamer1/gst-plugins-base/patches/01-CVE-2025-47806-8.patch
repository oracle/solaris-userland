From 6b19f117518a765a25c99d1c4b09f2838a8ed0c9 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Sebastian=20Dr=C3=B6ge?= <sebastian@centricular.com>
Date: Thu, 8 May 2025 09:04:52 +0300
Subject: [PATCH 1/3] tmplayer: Don't append NULL + 1 to the string buffer when
 parsing lines without text

Fixes https://gitlab.freedesktop.org/gstreamer/gstreamer/-/issues/4417
Fixes CVE-2025-47808

Part-of: <https://gitlab.freedesktop.org/gstreamer/gstreamer/-/merge_requests/9132>

--- a/gst/subparse/tmplayerparse.c	2025-08-07 18:02:30.961936861 -0700
+++ b/gst/subparse/tmplayerparse.c	2025-08-07 18:03:12.812448136 -0700
@@ -125,7 +125,9 @@
        * durations from the start times anyway, so as long as the parser just
        * forwards state->start_time by duration after it pushes the line we
        * are about to return it will all be good. */
-      g_string_append (state->buf, text_start + 1);
+      if (text_start) {
+        g_string_append (state->buf, text_start + 1);
+      } 
     } else if (line_num > 0) {
       GST_WARNING ("end of subtitle unit but no valid start time?!");
     }

From 9e2238adc1cad1fba5aad23bc8c2a6c2a65794d2 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Sebastian=20Dr=C3=B6ge?= <sebastian@centricular.com>
Date: Thu, 8 May 2025 09:14:15 +0300
Subject: [PATCH 2/3] subparse: Check for valid UTF-8 before cleaning up lines
 and check for regex replace errors

Fixes https://gitlab.freedesktop.org/gstreamer/gstreamer/-/issues/4418
Fixes CVE-2025-47807

Part-of: <https://gitlab.freedesktop.org/gstreamer/gstreamer/-/merge_requests/9132>

--- a/gst/subparse/gstsubparse.c	2025-08-07 18:15:42.467744141 -0700
+++ b/gst/subparse/gstsubparse.c	2025-08-07 18:17:41.666636101 -0700
@@ -664,6 +664,12 @@
   res = g_regex_replace (tag_regex, txt, strlen (txt), 0,
       replace_pattern, 0, NULL);
 
+  /* Replacing can fail. Return an empty string in that case. */
+  if (!res) {
+    strcpy (txt, "");
+    return;
+  }
+
   /* res will always be shorter than the input or identical, so this
    * copy is OK */
   strcpy (txt, res);
@@ -1035,6 +1041,10 @@
         g_string_append_c (state->buf, '\n');
       g_string_append (state->buf, line);
       if (strlen (line) == 0) {
+        if (!g_utf8_validate (state->buf->str, state->buf->len, NULL)) {
+          g_string_truncate (state->buf, 0);
+          return NULL;
+        }
         ret = g_markup_escape_text (state->buf->str, state->buf->len);
         g_string_truncate (state->buf, 0);
         state->state = 0;


From edca7f83d107fb6a55dbd46196fc40b99857a85e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Sebastian=20Dr=C3=B6ge?= <sebastian@centricular.com>
Date: Thu, 8 May 2025 12:46:40 +0300
Subject: [PATCH 3/3] subparse: Make sure that subrip time string is not too
 long before zero-padding

Fixes https://gitlab.freedesktop.org/gstreamer/gstreamer/-/issues/4419
Fixes CVE-2025-47806

Part-of: <https://gitlab.freedesktop.org/gstreamer/gstreamer/-/merge_requests/9132>
--- a/gst/subparse/gstsubparse.c	2025-08-07 18:18:46.954716146 -0700
+++ b/gst/subparse/gstsubparse.c	2025-08-07 18:19:51.284348875 -0700
@@ -854,7 +854,7 @@
   g_strdelimit (s, " ", '0');
   g_strdelimit (s, ".", ',');
 
-  /* make sure we have exactly three digits after he comma */
+  /* make sure we have exactly three digits after the comma */
   p = strchr (s, ',');
   if (p == NULL) {
     /* If there isn't a ',' the timestamp is broken */
@@ -861,6 +861,15 @@
     /* https://gitlab.freedesktop.org/gstreamer/gst-plugins-base/issues/532#note_100179 */
     GST_WARNING ("failed to parse subrip timestamp string '%s'", s);
     return FALSE;
+  }
+
+  /* Check if the comma is too far into the string to avoid
+   * stack overflow when zero-padding the sub-second part.
+   *
+   * Allow for 3 digits of hours just in case. */
+  if ((p - s) > sizeof ("hhh:mm:ss,")) {
+    GST_WARNING ("failed to parse subrip timestamp string '%s'", s);
+    return FALSE;
   }
 
   ++p;
